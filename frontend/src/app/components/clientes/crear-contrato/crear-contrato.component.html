<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="fw-bold mb-3">Contratos</h1>
    @if (!booleanCrearContrato) {
    <button type="button" class="btn btn-outline-primary" (click)="crearC()">
      Crear contrato
    </button>
    } @else {
    <button type="button" class="btn btn-outline-danger" (click)="crearC(true)">
      Cancelar
    </button>
    }
  </div>

  @if (booleanCrearContrato) {
  <div class="container mt-4 mb-5">
    <div class="row justify-content-center ju">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="mt-3">
              <h3 class="fw-bold mb-3">Nuevo Contrato</h3>
            </div>
            <p class="text-muted mb-4">
              Registra un contrato asociado a un cliente existente.
            </p>

            <form [formGroup]="form" (ngSubmit)="crearContrato()" class="row g-3">
              <div class="mb-3 col-4">
                <label class="form-label fw-bold" for="id_cliente">Cliente</label>
                <select
                  id="id_cliente"
                  class="form-select"
                  formControlName="id_cliente"
                >
                  <option [ngValue]="null">Seleccione un cliente...</option>
                  @for (cliente of clientes; track $index) {
                  <option [value]="cliente.id_cliente">
                    {{ cliente.nombre }} ({{ cliente.nit }})
                  </option>
                  }
                </select>
                @if (hasError('id_cliente', 'required')) {
                <div class="text-danger small">
                  Debe seleccionar un cliente.
                </div>
                }
              </div>

              <div class="mb-3 col-4">
                <label class="form-label fw-bold" for="nombre_proyecto"
                  >Nombre del proyecto / contrato</label
                >
                <input
                  id="nombre_proyecto"
                  type="text"
                  class="form-control"
                  formControlName="nombre_proyecto"
                />
                @if (hasError('nombre_proyecto', 'required')) {
                <div class="text-danger small">
                  El nombre del proyecto es obligatorio.
                </div>
                }
              </div>

              <div class="mb-3 col-4">
                <label class="form-label fw-bold" for="nivel_servicio"
                  >Service Level</label
                >
                <select
                  id="nivel_servicio"
                  class="form-select"
                  formControlName="nivel_servicio"
                >
                  <option [ngValue]="null">Select a service level...</option>
                  <option value="DIAMOND">Diamond</option>
                  <option value="GOLD">Gold</option>
                  <option value="SILVER">Silver</option>
                  <option value="BRONZE">Bronze</option>
                </select>
              </div>

                <div class="col-4 mb-3">
                  <label class="form-label fw-bold" for="fecha_inicio"
                    >Fecha inicio</label
                  >
                  <input
                    id="fecha_inicio"
                    type="date"
                    class="form-control"
                    formControlName="fecha_inicio"
                  />
                  @if (hasError('fecha_inicio', 'required')) {
                  <div class="text-danger small">
                    La fecha de inicio es obligatoria.
                  </div>
                  }
                </div>

                <div class="col-4 mb-3">
                  <label class="form-label fw-bold" for="fecha_fin">Fecha fin</label>
                  <input
                    id="fecha_fin"
                    type="date"
                    class="form-control"
                    formControlName="fecha_fin"
                  />
                </div>

              <div class="mb-3 col-4">
                <label class="form-label fw-bold" for="valor_mensual"
                  >Valor mensual</label
                >
                <input
                  id="valor_mensual"
                  type="number"
                  class="form-control"
                  formControlName="valor_mensual"
                  min="0"
                />
                @if (hasError('valor_mensual', 'required')) {
                <div class="text-danger small">
                  El valor mensual es obligatorio.
                </div>
                }
              </div>



              <div class="d-flex justify-content-end">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="loading"
                >
                  {{ loading ? "Guardando..." : "Crear Contrato" }}
                </button>
              </div>

              @if (errorMessage) {
              <div class="text-danger mt-3">
                {{ errorMessage }}
              </div>
              }
            </form>

            @if (contratoCreado) {
            <div class="alert alert-success mt-4">
              <h5 class="alert-heading mb-1">Contrato creado correctamente</h5>
              <p class="mb-0">
                <strong>ID:</strong> {{ contratoCreado.id_contrato }}<br />
                <strong>Proyecto:</strong> {{ contratoCreado.nombre_proyecto
                }}<br />
                <strong>Cliente ID:</strong> {{ contratoCreado.id_cliente
                }}<br />
                <strong>Estado:</strong> {{ contratoCreado.estado }}<br />
                <strong>Valor mensual:</strong>
                {{ contratoCreado.valor_mensual }}
              </p>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  @if (loading) {
  <div>Cargando...</div>
  } @if (!loading) {
  <table class="table table-striped mt-2">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Proyecto</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Valor mensual</th>
        <th>Nivel servicio</th>
        <th>Estado</th>
      </tr>
    </thead>

    <tbody>
      @for (contrato of listaContratos; track $index) {
      <tr>
        <td>{{ contrato.id_contrato }}</td>
        <td>{{ contrato.id_cliente }}</td>
        <td>{{ contrato.nombre_proyecto }}</td>
        <td>{{ formateadorFecha(contrato.fecha_inicio) }}</td>
        <td>{{ formateadorFecha(contrato.fecha_fin) || "-" }}</td>
        <td>{{ contrato.valor_mensual }}</td>
        <td>{{ contrato.nivel_servicio }}</td>
        <td>{{ contrato.estado }}</td>
      </tr>
      }
    </tbody>
  </table>
  }
</div>
