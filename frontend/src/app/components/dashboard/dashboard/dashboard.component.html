<div class="container my-4">
  <div class="mb-4">
    <h1 class="mb-1 fw-bold">Dashboard de Tickets y Soporte</h1>
    <p class="text-muted mb-0">
      Visión general del riesgo de las solicitudes, el riesgo de churn y la
      satisfacción de los clientes.
    </p>
  </div>

  @if (loading) {
  <div class="alert alert-info">Cargando dashboard...</div>
  } @if (errorMessage) {
  <div class="alert alert-danger">
    {{ errorMessage }}
  </div>
  } @if (!loading && data) {
  <!-- Tarjetas resumen -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h3 class="h6 text-uppercase text-muted mb-1">Total de tickets</h3>
          <p class="display-6 fw-semibold mb-1">{{ data.total_tickets }}</p>
          <p class="text-muted mb-0">Tickets registrados en el sistema.</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h3 class="h6 text-uppercase text-muted mb-1">
            Clientes con tickets
          </h3>
          <p class="display-6 fw-semibold mb-1">
            {{ data.total_clientes_con_tickets }}
          </p>
          <p class="text-muted mb-0">
            Clientes activos con interacción de soporte.
          </p>
        </div>
      </div>
    </div>

    <!-- Score global de churn -->
    <div class="col-md-4">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h3 class="h6 text-uppercase text-muted mb-1">
            Score global de churn
          </h3>
          <p class="display-6 fw-semibold mb-1">{{ churnScoreGlobal }} / 100</p>
          <p class="mb-0">
            Nivel actual:
            <span class="badge ms-1" [ngClass]="churnScoreBadgeClass">
              {{ churnScoreNivel }}
            </span>
          </p>
          <p class="text-muted small mb-0 mt-2">
            Promedio del riesgo de que los clientes abandonen la empresa, según
            todos los tickets analizados.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficas riesgo y satisfacción -->
  <div class="row g-3 mb-5">
    <!-- Riesgo de churn -->
    <div class="col-lg-6">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h4 class="fw-semibold mb-3">Distribución de riesgo de churn</h4>
          <p class="text-muted small mb-3">
            Proporción de tickets clasificados como ALTO, MEDIO, BAJO o sin dato
            (N/D).
          </p>
          <div class="d-flex justify-content-center">
            <canvas #riesgoChart height="220"></canvas>
          </div>
          <div class="mt-3">
            <ul class="list-unstyled small mb-0">
              <li>
                <span class="badge text-bg-danger me-1">ALTO</span>
                {{ getCantidadPorRiesgo("ALTO") }} tickets
              </li>
              <li>
                <span class="badge text-bg-warning me-1">MEDIO</span>
                {{ getCantidadPorRiesgo("MEDIO") }} tickets
              </li>
              <li>
                <span class="badge text-bg-success me-1">BAJO</span>
                {{ getCantidadPorRiesgo("BAJO") }} tickets
              </li>
              <li>
                <span class="badge text-bg-secondary me-1">N/D</span>
                {{ getCantidadPorRiesgo("N/D") }} tickets
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Satisfacción / Sentimiento -->
    <div class="col-lg-6">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h4 class="fw-semibold mb-3">Nivel de satisfacción</h4>
          <p class="text-muted small mb-3">
            Distribución de tickets según el sentimiento detectado en la
            interacción con el cliente.
          </p>

          <!-- Barra compuesta tipo KPI -->
          <div class="mb-3">
            <div class="progress" style="height: 30px">
              <div
                class="progress-bar bg-success"
                role="progressbar"
                [style.width]="porcentajePositivo + '%'"
              >
                {{ porcentajePositivo }}% satisfechos
              </div>
              <div
                class="progress-bar bg-warning text-dark"
                role="progressbar"
                [style.width]="porcentajeNeutro + '%'"
              >
                {{ porcentajeNeutro }}% neutros
              </div>
              <div
                class="progress-bar bg-danger"
                role="progressbar"
                [style.width]="porcentajeNegativo + '%'"
              >
                {{ porcentajeNegativo }}% insatisfechos
              </div>
            </div>
          </div>

          <!-- Gráfico de barras sentimiento -->
          <div class="d-flex justify-content-center">
            <canvas #satisfaccionChart height="220"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top clientes en riesgo: gráfica + tabla -->
  <div class="row g-3 mb-4">
    <!-- Gráfica top clientes -->
    <div class="col-lg-6">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <h4 class="fw-semibold mb-3">Top clientes por riesgo promedio</h4>
          <p class="text-muted small mb-3">
            Score promedio de churn por cliente en los últimos 30 días. Los
            clientes con mayor score deben ser priorizados en acciones de
            retención.
          </p>

          <div class="d-flex justify-content-center">
            <canvas #topClientesChart height="260"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de top clientes -->
    <div class="col-lg-6">
      <div class="card rounded-4 shadow-sm h-100">
        <div class="card-body px-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="fw-bold mb-0">Detalle de clientes prioritarios</h4>
            <span class="badge rounded-pill text-bg-danger">
              {{ data.top_clientes.length }} clientes
            </span>
          </div>

          @if (data.top_clientes.length > 0) {
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Cliente</th>
                  <th>Tickets</th>
                  <th>Score churn</th>
                  <th>Riesgo</th>
                  <th class="text-center">Prioridad</th>
                </tr>
              </thead>
              <tbody>
                @for (cliente of data.top_clientes; track cliente.id_cliente) {
                <tr>
                  <td>
                    <a
                      [routerLink]="['/cliente-detalle', cliente.id_cliente]"
                      class="text-decoration-none"
                    >
                      {{ cliente.nombre_cliente }}
                    </a>
                  </td>
                  <td>{{ cliente.total_tickets }}</td>
                  <td>
                    {{ cliente.promedio_score_churn | number : "1.0-1" }}/100
                  </td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="{
                        'text-bg-danger':
                          cliente.riesgo_predominante === 'ALTO',
                        'text-bg-warning':
                          cliente.riesgo_predominante === 'MEDIO',
                        'text-bg-success':
                          cliente.riesgo_predominante === 'BAJO',
                        'text-bg-secondary': !cliente.riesgo_predominante
                      }"
                    >
                      {{ cliente.riesgo_predominante || "N/D" }}
                    </span>
                  </td>
                  <td class="text-center">
                    @if (cliente.riesgo_predominante === 'ALTO') {
                    <span class="badge text-bg-danger">Crítico</span>
                    } @else if (cliente.riesgo_predominante === 'MEDIO') {
                    <span class="badge text-bg-warning text-dark">
                      Alerta
                    </span>
                    } @else if (cliente.riesgo_predominante === 'BAJO') {
                    <span class="badge text-bg-success"> Estable </span>
                    } @else {
                    <span class="badge text-bg-secondary">Sin dato</span>
                    }
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          } @else {
          <div class="alert alert-info mb-0">
            No hay clientes suficientes para calcular el top de riesgo.
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  }
</div>

